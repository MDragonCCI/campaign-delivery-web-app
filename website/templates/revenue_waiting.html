{% extends "base.html" %}
{% block title %}Campaign Delivery toolkit Home {% endblock %}
{% block head %}
<meta http-equiv="refresh" content="0.1">{% endblock %}
{% block content %}
<h1>Campaign Extractor</h1>
<hr>
<h2>Extracting Live data from Brodsign this might take 5-10 mins.</h2>
<br>
<form method="POST">


    <div class="progress" style="height: 20px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: {{session.get("proposal_progress")}}%;" aria-valuenow="{{session.get("proposal_done")}}" aria-valuemin="0" aria-valuemax="{{session.get("proposal_total_numbers")}}">{{session.get("proposal_done")}} out of {{session.get("proposal_total_numbers")}}</div>
    </div>





</form>
<br />
<br />
<script>
const FPS = 10
               let pixel = 20
               let cols = 8
               let rows = 16
               let frame = 0
               let posY = 0
               let posX = 0
               let placed = true
               let piece = null
               let field = []
               let canvas = document.createElement('CANVAS')
               canvas.width = pixel * cols
               canvas.height = pixel * rows
               canvas.style.background = 'black'
               canvas.style = "position:absolute; left: 50%; width: 400px; margin-left: -200px;";
               document.body.appendChild(canvas)

               let ctx = canvas.getContext('2d')

               let pieces = [
                   {
                       x: 0.5,
                       y: 0.5,
                       w: 2,
                       h: 2,
                       c: 'yellow',
                       m: [
                           [1, 1],
                           [1, 1]
                       ]
                   },
                   {
                       x: 1,
                       y: 0,
                       w: 4,
                       h: 2,
                       c: 'red',
                       m: [
                           [1, 1, 1, 1],
                           [0, 0, 0, 0]
                       ]
                   }
               ]

               function getPiece() {
                   return pieces[Math.floor(Math.random() * pieces.length)]
               }

               function getEmptyRow() {
                   let row = []
                   for (let c = 0; c < cols; c++) {
                       row.push({ c: null, m: 0 })
                   }
                   return row
               }

               function rotate(matrix) {
                   matrix = matrix.reverse()

                   for (var i = 0; i < matrix.length; i++) {
                       for (var j = 0; j < i; j++) {
                           var temp = matrix[i][j]
                           matrix[i][j] = matrix[j][i]
                           matrix[j][i] = temp
                       }
                   }
               }

               function addPieceToField(piece, posX, posY) {
                   for (let r = 0; r < piece.h; r++) {
                       for (let c = 0; c < piece.w; c++) {
                           if (piece.m[r][c]) {
                               field[posY - piece.h + r][posX + c].m = 1
                               field[posY - piece.h + r][posX + c].c = piece.c
                           }
                       }
                   }
               }

               for (let r = 0; r < rows; r++) {
                   field[r] = []
                   for (let c = 0; c < cols; c++) {
                       field[r][c] = { c: null, m: 0 }
                   }
               }

               window.onkeyup = e => {
                   if (e.keyCode === 37 && posX > 0) posX--
                   if (e.keyCode === 39 && posX + piece.w < cols) posX++
                   if (e.keyCode === 40 && posY < rows) posY++
                   if (e.keyCode === 38) rotate(piece.m)
               }

               function draw() {
                   if (++frame >= FPS) {
                       frame = 0

                       if (placed) {
                           piece = getPiece()
                           posY = -piece.h
                           posX = Math.floor(Math.random() * (cols - piece.w))
                           placed = false
                       }

                       ctx.clearRect(0, 0, canvas.width, canvas.height)
                       ctx.fillStyle = piece.c
                       for (let r = 0; r < piece.h; r++) {
                           let pieceY = (posY + r) * pixel
                           for (let c = 0; c < piece.w; c++) {
                               if (piece.m[r][c] && !placed) {
                                   let pieceX = (posX + c) * pixel
                                   ctx.fillRect(pieceX, pieceY, pixel, pixel)

                                   if (posY + r >= rows || (posY >= 0 && field[posY + r][posX + c].m === 1)) {
                                       ctx.clearRect(0, 0, canvas.width, canvas.height)
                                       addPieceToField(piece, posX, posY + 1)
                                       placed = true
                                   }
                               }
                           }
                       }

                       for (let r = rows - 1; r >= 0; r--) {
                           let pieceY = r * pixel
                           if (field[r].reduce((a, b) => a + b.m, 0) === cols) {
                               field.splice(r, 1)
                               field.unshift(getEmptyRow())
                               r++
                           } else {
                               for (let c = cols - 1; c >= 0; c--) {
                                   if (field[r][c] && field[r][c].m) {
                                       let pieceX = c * pixel
                                       ctx.fillStyle = field[r][c].c
                                       ctx.fillRect(pieceX, pieceY, pixel, pixel)
                                   }
                               }
                           }
                       }

                       posY++
                   }

                   window.requestAnimationFrame(draw)
               }

               window.requestAnimationFrame(draw)</script>


    {% endblock %}
