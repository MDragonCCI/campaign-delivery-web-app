{% extends "base.html" %}
{% block title %}Campaign Delivery Revenue extractor {% endblock %}
{% block content %}
<h1>Campaign extractor</h1>
<hr>
<form method="POST">
    <div id="loading">
        <br />
       <div class="content">
           <script>const FPS = 10
               let pixel = 20
               let cols = 15
               let rows = 30
               let frame = 0
               let posY = 0
               let posX = 0
               let placed = true
               let piece = null
               let field = []
               let canvas = document.createElement('CANVAS')
               canvas.width = pixel * cols
               canvas.height = pixel * rows
               canvas.style.background = 'black'
               canvas.style = "position:absolute; left: 50%; width: 400px; margin-left: -200px;";
               document.body.appendChild(canvas)

               let ctx = canvas.getContext('2d')

               let pieces = [
                   {
                       x: 0.5,
                       y: 0.5,
                       w: 2,
                       h: 2,
                       c: 'yellow',
                       m: [
                           [1, 1],
                           [1, 1]
                       ]
                   },
                   {
                       x: 1,
                       y: 0,
                       w: 4,
                       h: 2,
                       c: 'red',
                       m: [
                           [1, 1, 1, 1],
                           [0, 0, 0, 0]
                       ]
                   }
               ]

               function getPiece() {
                   return pieces[Math.floor(Math.random() * pieces.length)]
               }

               function getEmptyRow() {
                   let row = []
                   for (let c = 0; c < cols; c++) {
                       row.push({ c: null, m: 0 })
                   }
                   return row
               }

               function rotate(matrix) {
                   matrix = matrix.reverse()

                   for (var i = 0; i < matrix.length; i++) {
                       for (var j = 0; j < i; j++) {
                           var temp = matrix[i][j]
                           matrix[i][j] = matrix[j][i]
                           matrix[j][i] = temp
                       }
                   }
               }

               function addPieceToField(piece, posX, posY) {
                   for (let r = 0; r < piece.h; r++) {
                       for (let c = 0; c < piece.w; c++) {
                           if (piece.m[r][c]) {
                               field[posY - piece.h + r][posX + c].m = 1
                               field[posY - piece.h + r][posX + c].c = piece.c
                           }
                       }
                   }
               }

               for (let r = 0; r < rows; r++) {
                   field[r] = []
                   for (let c = 0; c < cols; c++) {
                       field[r][c] = { c: null, m: 0 }
                   }
               }

               window.onkeyup = e => {
                   if (e.keyCode === 37 && posX > 0) posX--
                   if (e.keyCode === 39 && posX + piece.w < cols) posX++
                   if (e.keyCode === 40 && posY < rows) posY++
                   if (e.keyCode === 38) rotate(piece.m)
               }

               function draw() {
                   if (++frame >= FPS) {
                       frame = 0

                       if (placed) {
                           piece = getPiece()
                           posY = -piece.h
                           posX = Math.floor(Math.random() * (cols - piece.w))
                           placed = false
                       }

                       ctx.clearRect(0, 0, canvas.width, canvas.height)
                       ctx.fillStyle = piece.c
                       for (let r = 0; r < piece.h; r++) {
                           let pieceY = (posY + r) * pixel
                           for (let c = 0; c < piece.w; c++) {
                               if (piece.m[r][c] && !placed) {
                                   let pieceX = (posX + c) * pixel
                                   ctx.fillRect(pieceX, pieceY, pixel, pixel)

                                   if (posY + r >= rows || (posY >= 0 && field[posY + r][posX + c].m === 1)) {
                                       ctx.clearRect(0, 0, canvas.width, canvas.height)
                                       addPieceToField(piece, posX, posY + 1)
                                       placed = true
                                   }
                               }
                           }
                       }

                       for (let r = rows - 1; r >= 0; r--) {
                           let pieceY = r * pixel
                           if (field[r].reduce((a, b) => a + b.m, 0) === cols) {
                               field.splice(r, 1)
                               field.unshift(getEmptyRow())
                               r++
                           } else {
                               for (let c = cols - 1; c >= 0; c--) {
                                   if (field[r][c] && field[r][c].m) {
                                       let pieceX = c * pixel
                                       ctx.fillStyle = field[r][c].c
                                       ctx.fillRect(pieceX, pieceY, pixel, pixel)
                                   }
                               }
                           }
                       }

                       posY++
                   }

                   window.requestAnimationFrame(draw)
               }

               window.requestAnimationFrame(draw)</script>
       </div>
    </div>
    <div id="content">
        <form method="POST">
            <h3>Select date range for the report</h3>
            <div class="container">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <!-- Date input -->
                            <label class="control-label" for="date">Date from</label>
                            <input class="form-control" id="date" name="date" placeholder="YYYY-MM-DD" type="text" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <!-- Date input -->
                            <label class="control-label" for="date1">Date till</label>
                            <input class="form-control" id="date1" name="date1" placeholder="YYYY-MM-DD" type="text" />
                        </div>
                    </div>
                </div>
            </div>


            <br />
            <div class="container">
                <div class="row">
                    <div class="col-md-6">
                        <h4>Select Proposals statuses</h4>
                        <div class="form-check param">
                            <input class="form-check-input" type="checkbox" value="1" name="Live" id="Live" checked disabled>
                            <label class="form-check-label" for="Live">
                                Live
                            </label>
                        </div>
                        <div class="form-check param">
                            <input class="form-check-input" type="checkbox" value="1" name="Submitted" id="Submitted" checked>
                            <label class="form-check-label" for="Submitted">
                                Submitted
                            </label>
                        </div>
                        <div class="form-check param">
                            <input class="form-check-input" type="checkbox" value="1" name="Booked" id="Booked" checked>
                            <label class="form-check-label" for="Booked">
                                Booked
                            </label>
                        </div>
                        <div class="form-check param">
                            <input class="form-check-input" type="checkbox" value="1" name="Ended" id="Ended" checked>
                            <label class="form-check-label" for="Ended">
                                Ended
                            </label>
                        </div>
                        <div class="form-check param">
                            <input class="form-check-input" type="checkbox" value="1" name="Hold" id="Hold" checked>
                            <label class="form-check-label" for="Hold">
                                Held
                            </label>
                        </div>
                        <br />
                    </div>
                    <div class="col-md-6">
                        <h4>Additional options:</h4>
                        <div class="form-check param">
                            <input class="form-check-input" type="checkbox" value="1" name="preempt" id="preempt">
                            <label class="form-check-label" for="preempt">
                                Preemptibles
                            </label>
                        </div>
                        <div class="form-check param">
                            <input class="form-check-input" type="checkbox" value="1" name="Allocation_Stats" id="flexCheckChecked">
                            <label class="form-check-label" for="flexCheckChecked">
                                Allocation statistics
                            </label>
                        </div>
                    </div>
                </div>
                <br />

            </div>
            <div class="container">
                <div class="row">
                    <div class="col-md-12 text-center">
                        <button type="submit" class="btn btn-primary" style="width: 40%; height: 50px;" onclick="loading();">Generate</button>
                    </div>
                </div>
            </div>
            <br />
            <br />
            {% if session.get("ce_last_run") %}

            <p>The last run of the report was on the {{session.get("ce_last_run")}} click <a href='/revenue/summary'>here</a> to access it! </p>
            {% endif %}

            {% endblock %}
    </div>

</form>


